name: Deploy Production

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux]
    environment: oracle-cloud-solicare-instance

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build \
            --build-arg REACT_APP_BASE_API_URL='${{ vars.REACT_APP_BASE_API_URL }}' \
            -t ghcr.io/${{ env.IMAGE_NAME_LC }}:latest \
            -t ghcr.io/${{ env.IMAGE_NAME_LC }}:master \
            -t ghcr.io/${{ env.IMAGE_NAME_LC }}:${{ github.sha }} .

      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ env.IMAGE_NAME_LC }}:latest
          docker push ghcr.io/${{ env.IMAGE_NAME_LC }}:master
          docker push ghcr.io/${{ env.IMAGE_NAME_LC }}:${{ github.sha }}

      - name: Start new container for verification
        run: |
          docker run -d \
            --name solicare-frontend-new \
            -p ${{ vars.CHECK_PORT || '8081' }}:80 \
            ghcr.io/${{ env.IMAGE_NAME_LC }}:latest

      - name: Verify new container health
        run: |
          for i in {1..15}; do
            if curl -sSf http://localhost:${{ vars.CHECK_PORT || '8081' }}${{ vars.CHECK_PATH || '/' }} > /dev/null; then
              echo "[SUCCESS] New container is healthy."
              exit 0
            fi
            echo "Waiting for health check... ($i/15)"
            sleep 2
          done
          echo "[ERROR] Health check failed. Rolling back..."
          docker logs solicare-frontend-new
          docker rm -f solicare-frontend-new
          exit 1

      - name: Switch to new container
        run: |
          docker stop solicare-frontend || true
          docker rm solicare-frontend || true
          docker rm -f solicare-frontend-new

          docker run -d \
            --name solicare-frontend \
            --restart unless-stopped \
            -p ${{ vars.SERVER_PORT || '80' }}:80 \
            ghcr.io/${{ env.IMAGE_NAME_LC }}:latest

          echo "[SUCCESS] Container switched successfully."

      - name: Cleanup old images
        run: |
          docker image prune -f --filter "until=24h"
